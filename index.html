<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>B√°o c√°o Qu√¢n s·ªë ƒê·∫°i ƒë·ªôi</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a"> <!-- M√†u thanh tr·∫°ng th√°i kh·ªõp v·ªõi bg-slate-900 -->

  <!-- Th∆∞ vi·ªán x·ª≠ l√Ω Excel v√† PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Th√™m Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- C·∫•u h√¨nh Tailwind (n·∫øu c·∫ßn custom th√™m) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'military-green': '#4ade80', // M√†u ƒëi·ªÉm nh·∫•n
          }
        }
      }
    }
  </script>

  <style>
    /* Ch·ªâ gi·ªØ l·∫°i style cho thanh cu·ªôn t√πy ch·ªânh n·∫øu mu·ªën, c√≤n l·∫°i d√πng Tailwind */
    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    /* ·∫®n m≈©i t√™n tƒÉng gi·∫£m trong input number */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    /* CSS Ri√™ng cho Footer Li√™n H·ªá (T√°ch t·ª´ th·∫ª <style>) */

/* SC-Contact-Footer: Ph·∫ßn wrapper c·ªë ƒë·ªãnh ·ªü d∆∞·ªõi c√πng */
.sc-contact-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 99999; /* ƒê·∫£m b·∫£o lu√¥n n·ªïi l√™n tr√™n */
    background: rgba(17, 24, 39, 0.85); /* M√†u n·ªÅn t·ªëi m·ªù (Gray 900) */
    backdrop-filter: blur(10px); /* Hi·ªáu ·ª©ng k√≠nh m·ªù */
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    font-family: Arial, sans-serif;
    padding: 10px 0;
    box-sizing: border-box;
}

/* SC-Footer-Container: CƒÉn gi·ªØa n·ªôi dung */
.sc-footer-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* T·ª± xu·ªëng d√≤ng tr√™n m√†n h√¨nh nh·ªè */
}

/* Ph·∫ßn ch·ªØ b√™n tr√°i */
.sc-left-content {
    color: #9ca3af; /* Gray 400 */
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sc-brand-name {
    font-weight: bold;
    background: linear-gradient(to right, #60a5fa, #c084fc); /* Gradient ch·ªØ */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Ph·∫ßn n√∫t b·∫•m b√™n ph·∫£i */
.sc-right-content {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* Style chung cho c√°c n√∫t (SC-Social-Btn) */
.sc-social-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    text-decoration: none;
    color: white;
    font-size: 18px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    border: none;
    outline: none;
    cursor: pointer;
}

.sc-social-btn:hover {
    transform: translateY(-3px) scale(1.1);
}

/* Tooltip hi·ªÉn th·ªã t√™n/sdt khi di chu·ªôt v√†o */
.sc-tooltip {
    position: absolute;
    bottom: 50px; /* Hi·ªán ph√≠a tr√™n n√∫t */
    left: 50%;
    transform: translateX(-50%);
    background-color: white;
    color: #333;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    pointer-events: none;
}
 
/* M≈©i t√™n nh·ªè c·ªßa tooltip */
.sc-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: white transparent transparent transparent;
}

.sc-social-btn:hover .sc-tooltip {
    opacity: 1;
    visibility: visible;
}

/* --- M√ÄU S·∫ÆC T·ª™NG N√öT --- */
 
/* ƒêi·ªán tho·∫°i: Xanh l√° */
.btn-phone {
    background: linear-gradient(135deg, #4ade80, #15803d);
    box-shadow: 0 4px 10px rgba(22, 163, 74, 0.4);
}
.btn-phone:hover { box-shadow: 0 6px 15px rgba(22, 163, 74, 0.6); }

/* Rung l·∫Øc nh·∫π cho ƒëi·ªán tho·∫°i */
@keyframes sc-wiggle {
    0%, 100% { transform: rotate(-3deg); }
    50% { transform: rotate(3deg); }
}
.btn-phone:hover i {
    animation: sc-wiggle 0.3s ease-in-out infinite;
}

/* Facebook: Xanh d∆∞∆°ng */
.btn-facebook {
    background: linear-gradient(135deg, #18ACFE, #0163E0);
    box-shadow: 0 4px 10px rgba(1, 99, 224, 0.4);
}
.btn-facebook:hover { box-shadow: 0 6px 15px rgba(1, 99, 224, 0.6); }

/* TikTok: ƒêen x√°m */
.btn-tiktok {
    background: linear-gradient(135deg, #374151, #000000);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    border: 1px solid #4b5563;
}
.btn-tiktok:hover { box-shadow: 0 6px 15px rgba(255, 255, 255, 0.2); border-color: #ec4899; }
 
/* Instagram: T√≠m Cam */
.btn-instagram {
    background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
    box-shadow: 0 4px 10px rgba(253, 29, 29, 0.4);
}
.btn-instagram:hover { box-shadow: 0 6px 15px rgba(253, 29, 29, 0.6); }

/* Responsive cho ƒëi·ªán tho·∫°i: X·∫øp d·ªçc n·∫øu c·∫ßn ho·∫∑c cƒÉn gi·ªØa */
@media (max-width: 600px) {
    .sc-footer-container {
        flex-direction: column-reverse; /* ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ icon l√™n tr√™n, ch·ªØ xu·ªëng d∆∞·ªõi */
        gap: 10px;
    }
    .sc-left-content {
        font-size: 12px;
    }
    .sc-social-btn {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
}
  </style>
</head>
<body class="bg-slate-900 text-slate-50 min-h-screen flex flex-col font-sans">

  <!-- Main Content -->
  <main class="flex-grow w-full max-w-5xl mx-auto p-4 md:p-6 pb-24">
    
    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="text-2xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 uppercase tracking-wide drop-shadow-sm">
        ü™ñ B√°o c√°o Qu√¢n s·ªë
      </h1>
      
    </header>

    <!-- Card ch·ª©a b·∫£ng -->
    <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
      
      <!-- Wrapper cho b·∫£ng ƒë·ªÉ scroll ngang tr√™n mobile -->
      <div class="overflow-x-auto w-full">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-slate-700/50 text-slate-300 text-xs md:text-sm uppercase tracking-wider border-b border-slate-600">
              <th class="p-4 font-semibold min-w-[80px]">L·ªõp</th>
              <th class="p-4 font-semibold text-center min-w-[60px]">Qƒê</th>
              <th class="p-4 font-semibold text-center min-w-[80px]">TT</th>
              <th class="p-4 font-semibold text-center min-w-[60px]">V·∫Øng</th>
              <th class="p-4 font-semibold min-w-[200px]">L√Ω do v·∫Øng (VD: 1 ·ªëm, 2 g√°c)</th>
            </tr>
          </thead>
          <tbody id="tbody" class="text-sm divide-y divide-slate-700">
            <!-- Rows s·∫Ω ƒë∆∞·ª£c JS render v√†o ƒë√¢y -->
          </tbody>
        </table>
      </div>

      <!-- Khu v·ª±c ƒëi·ªÅu khi·ªÉn (Buttons) -->
      <div class="p-4 bg-slate-800 border-t border-slate-700">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button id="calcBtn" class="col-span-2 md:col-span-1 py-2.5 px-4 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìä</span> T√≠nh t·ªïng
          </button>
          
          <button id="excelBtn" class="py-2.5 px-4 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white font-semibold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìó</span> Excel
          </button>
          
          <button id="pdfBtn" class="py-2.5 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìò</span> PDF
          </button>
          
          <button id="clearBtn" class="py-2.5 px-4 bg-slate-600 hover:bg-slate-500 active:bg-slate-700 text-white font-medium rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üóëÔ∏è</span> X√≥a
          </button>
        </div>
      </div>

      <!-- K·∫øt qu·∫£ -->
      <div id="result" class="hidden border-t border-slate-700 bg-slate-900/50 p-6 text-slate-200 animate-fade-in">
        <!-- JS ƒëi·ªÅn k·∫øt qu·∫£ v√†o ƒë√¢y -->
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="sc-contact-footer">
    <div class="sc-footer-container">
        <!-- G√≥c Tr√°i: Text -->
        <div class="sc-left-content">
            <span>Design by <span class="sc-brand-name">S∆°n Cris</span></span>
        </div>

        <!-- G√≥c Ph·∫£i: Icons -->
        <div class="sc-right-content">
            <!-- SƒêT -->
            <a href="tel:0327208690" class="sc-social-btn btn-phone">
                <i class="fas fa-phone-alt"></i>
                <span class="sc-tooltip">0327.208.690</span>
            </a>

            <!-- Facebook -->
            <a href="https://web.facebook.com/sonsadboiz.12" target="_blank" class="sc-social-btn btn-facebook">
                <i class="fab fa-facebook-f"></i>
                <span class="sc-tooltip">Facebook</span>
            </a>

            <!-- TikTok -->
            <a href="https://www.tiktok.com/@chubodoihaybuon" target="_blank" class="sc-social-btn btn-tiktok">
                <i class="fab fa-tiktok"></i>
                <span class="sc-tooltip">TikTok</span>
            </a>

            <!-- Instagram -->
            <a href="https://www.instagram.com/son_cris3012/?__pwa=1" target="_blank" class="sc-social-btn btn-instagram">
                <i class="fab fa-instagram"></i>
                <span class="sc-tooltip">Instagram</span>
            </a>
        </div>
    </div>
</footer>
  <script>
    const defaultClasses = [
      { id: 'CNTT1', qd: 24 },
      { id: 'CNTT2', qd: 24 },
      { id: 'TTNT', qd: 15 },
      { id: 'BDATTT', qd: 8 },
      { id: 'TBBKNL', qd: 10 },
      { id: 'TL', qd: 8 }
    ];

    const STORAGE_KEY = 'quanso_data_v1';

    function loadData(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){
        try { return JSON.parse(saved); } catch(e) { localStorage.removeItem(STORAGE_KEY); }
      }
      const init = {};
      defaultClasses.forEach(c => { init[c.id] = { qd: c.qd, tt: '', lydo: '' } });
      return init;
    }

    let data = loadData();

    function renderTable(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      for(const id in data){
        const row = data[id];
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-700/30 transition-colors";
        
        // T√≠nh to√°n v·∫Øng ngay l√∫c render ƒë·ªÉ hi·ªán th·ªã m√†u s·∫Øc
        const qd = Number(row.qd);
        const tt = Number(row.tt) || 0;
        const vang = Math.max(0, qd - tt);
        const vangClass = vang > 0 ? "text-red-400 font-bold" : "text-slate-400";

        tr.innerHTML = `
          <td class="p-3 border-b border-slate-700 font-medium text-slate-200">${id}</td>
          <td class="p-3 border-b border-slate-700 text-center text-slate-300">${row.qd}</td>
          <td class="p-3 border-b border-slate-700 text-center">
            <input type="number" data-id="${id}" class="tt bg-slate-900/80 border border-slate-600 text-center text-white rounded w-16 md:w-20 py-1 focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-all" value="${row.tt ?? ''}" placeholder="0" min="0">
          </td>
          <td id="${id}_vang" class="p-3 border-b border-slate-700 text-center ${vangClass}">${vang}</td>
          <td class="p-3 border-b border-slate-700">
            <input type="text" data-id="${id}" class="lydo bg-slate-900/80 border border-slate-600 text-white rounded w-full py-1 px-2 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" value="${row.lydo ?? ''}" placeholder="Nh·∫≠p l√Ω do...">
          </td>
        `;
        tbody.appendChild(tr);
      }
      attachListeners();
    }
    renderTable();

    function saveData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function tinhTongHop(){
      let tongQD=0, tongTT=0, tongVang=0;
      let tongLyDo=0; // Bi·∫øn t·ªïng ƒë·ªÉ check l·ªói
      const statLyDo = {};

      for(const id in data){
        const qd = Number(data[id].qd) || 0;
        const tt = Number(data[id].tt) || 0;
        const vang = Math.max(0, qd - tt);

        tongQD += qd;
        tongTT += tt;
        tongVang += vang;

        const s = (data[id].lydo || '').trim();
        if(s){
          s.split(',').map(p=>p.trim()).forEach(part=>{
            // Regex t√¨m s·ªë ·ªü ƒë·∫ßu c√¢u (v√≠ d·ª• "2 ·ªëm" -> 2, "·ªëm" -> null)
            const m = part.match(/^(\d+)\s*(.+)$/);
            if(m){
              const so = parseInt(m[1],10);
              const ten = m[2].trim();
              if(ten) {
                  statLyDo[ten] = (statLyDo[ten]||0) + so;
                  tongLyDo += so; // C·ªông d·ªìn s·ªë ng∆∞·ªùi trong l√Ω do ƒë·ªÉ so s√°nh
              }
            }
          });
        }
        
        // C·∫≠p nh·∫≠t l·∫°i m√†u text c·ªôt v·∫Øng
        const elVang = document.getElementById(id + '_vang');
        if(elVang) {
            elVang.textContent = vang;
            elVang.className = `p-3 border-b border-slate-700 text-center ${vang > 0 ? "text-red-400 font-bold" : "text-slate-400"}`;
        }
      }

      const resDiv = document.getElementById('result');
      resDiv.classList.remove('hidden');

      // --- LOGIC KI·ªÇM TRA M·ªöI ---
      // So s√°nh t·ªïng v·∫Øng v√† t·ªïng s·ªë l∆∞·ª£ng khai b√°o trong l√Ω do
      if (tongVang !== tongLyDo) {
        resDiv.innerHTML = `
          <div class="flex flex-col items-center justify-center p-6 bg-red-500/10 border-2 border-red-500 rounded-xl text-center animate-pulse">
            <div class="text-5xl mb-3">‚ö†Ô∏è</div>
            <h3 class="text-2xl font-bold text-red-500 uppercase mb-2">Tr·ª±c ban ki·ªÉm tra l·∫°i vi·ªác nh·∫≠p</h3>
            <p class="text-slate-300 text-lg">
              T·ªïng s·ªë v·∫Øng th·ª±c t·∫ø (<b class="text-white">${tongVang}</b>) kh√¥ng kh·ªõp v·ªõi t·ªïng s·ªë b√°o l√Ω do (<b class="text-white">${tongLyDo}</b>).
            </p>
            <p class="text-sm text-slate-400 mt-2 italic">(Vui l√≤ng ki·ªÉm tra l·∫°i s·ªë l∆∞·ª£ng trong c·ªôt "L√Ω do v·∫Øng")</p>
          </div>
        `;
        return; // D·ª´ng l·∫°i, kh√¥ng in b√°o c√°o
      }

      // N·∫øu KH·ªöP -> Xu·∫•t b√°o c√°o
      let html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">Qu√¢n s·ªë quy ƒë·ªãnh</p>
                <p class="text-2xl font-bold text-white">${tongQD}</p>
            </div>
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">Th·ª±c t·∫ø c√≥ m·∫∑t</p>
                <p class="text-2xl font-bold text-green-400">${tongTT}</p>
            </div>
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">T·ªïng v·∫Øng</p>
                <p class="text-2xl font-bold text-red-400">${tongVang}</p>
            </div>
        </div>
        
        <h3 class="font-semibold text-lg text-blue-300 mb-2 border-b border-slate-700 pb-1">Chi ti·∫øt l√Ω do v·∫Øng:</h3>
      `;
      
      if(Object.keys(statLyDo).length){
        html += '<ul class="space-y-1 list-disc list-inside text-slate-300">';
        for(const name in statLyDo) html += `<li><span class="text-white font-medium">${name}:</span> <span class="text-yellow-400 font-bold">${statLyDo[name]}</span></li>`;
        html += '</ul>';
      } else {
        html += '<p class="text-slate-500 italic">‚Äî Kh√¥ng c√≥ d·ªØ li·ªáu l√Ω do h·ª£p l·ªá (ƒê·ªãnh d·∫°ng: "S·ªë l∆∞·ª£ng + L√Ω do") ‚Äî</p>';
      }

      resDiv.innerHTML = html;
    }

    function attachListeners(){
      const inputs = [...document.querySelectorAll('input.tt, input.lydo')];
      inputs.forEach((inp,i) => {
        inp.addEventListener('input', e=>{
          const id = e.target.dataset.id;
          if(!id) return;
          if(e.target.classList.contains('tt')) data[id].tt = e.target.value;
          if(e.target.classList.contains('lydo')) data[id].lydo = e.target.value;
          saveData();
          
          // C·∫≠p nh·∫≠t ngay s·ªë v·∫Øng khi nh·∫≠p
          const qd = Number(data[id].qd)||0, tt = Number(data[id].tt)||0;
          const vang = Math.max(0, qd - tt);
          const el = document.getElementById(id + '_vang');
          if(el) {
              el.textContent = vang;
              // Update style realtime
              el.className = `p-3 border-b border-slate-700 text-center ${vang > 0 ? "text-red-400 font-bold" : "text-slate-400"}`;
          }
        });

        inp.addEventListener('keydown', e=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            const next = inputs[i+1] || inputs[0];
            next.focus();
            next.select && next.select();
          }
        });
      });
    }

    document.getElementById('calcBtn').addEventListener('click', tinhTongHop);

    document.getElementById('excelBtn').addEventListener('click', ()=>{
      const aoa = [['L·ªõp','Qƒê','TT','V·∫Øng','L√Ω do']];
      for(const id in data){
        const qd = data[id].qd;
        const tt = data[id].tt || 0;
        const vang = Math.max(0, qd - (Number(tt)||0));
        aoa.push([id, qd, tt, vang, data[id].lydo || '']);
      }
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), 'BaoCao');
      XLSX.writeFile(wb, 'BaoCao_QuanSo.xlsx');
    });

    document.getElementById('pdfBtn').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('BAO CAO QUAN SO DAI DOI', 105, 20, null, null, 'center');
      
      const rows = Object.keys(data).map(id => {
        const qd = data[id].qd;
        const tt = data[id].tt || 0;
        const vang = Math.max(0, qd - (Number(tt)||0));
        return [id, String(qd), String(tt), String(vang), data[id].lydo || ''];
      });
      
      doc.autoTable({ 
        startY: 30, 
        head: [['Lop','QD','TT','Vang','Ly do']], 
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
      });
      doc.save('BaoCao_QuanSo.pdf');
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u?')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = loadData();
      renderTable();
      document.getElementById('result').classList.add('hidden');
    });

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
