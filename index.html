<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>B√°o c√°o Qu√¢n s·ªë ƒê·∫°i ƒë·ªôi</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a"> <!-- M√†u thanh tr·∫°ng th√°i kh·ªõp v·ªõi bg-slate-900 -->

  <!-- Th∆∞ vi·ªán x·ª≠ l√Ω Excel v√† PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Th√™m Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- C·∫•u h√¨nh Tailwind (n·∫øu c·∫ßn custom th√™m) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'military-green': '#4ade80', // M√†u ƒëi·ªÉm nh·∫•n
          }
        }
      }
    }
  </script>

  <style>
    /* Ch·ªâ gi·ªØ l·∫°i style cho thanh cu·ªôn t√πy ch·ªânh n·∫øu mu·ªën, c√≤n l·∫°i d√πng Tailwind */
    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    /* ·∫®n m≈©i t√™n tƒÉng gi·∫£m trong input number */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-50 min-h-screen flex flex-col font-sans">

  <!-- Main Content -->
  <main class="flex-grow w-full max-w-5xl mx-auto p-4 md:p-6 pb-24">
    
    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="text-2xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 uppercase tracking-wide drop-shadow-sm">
        ü™ñ B√°o c√°o Qu√¢n s·ªë
      </h1>
      
    </header>

    <!-- Card ch·ª©a b·∫£ng -->
    <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
      
      <!-- Wrapper cho b·∫£ng ƒë·ªÉ scroll ngang tr√™n mobile -->
      <div class="overflow-x-auto w-full">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-slate-700/50 text-slate-300 text-xs md:text-sm uppercase tracking-wider border-b border-slate-600">
              <th class="p-4 font-semibold min-w-[80px]">L·ªõp</th>
              <th class="p-4 font-semibold text-center min-w-[60px]">Qƒê</th>
              <th class="p-4 font-semibold text-center min-w-[80px]">TT</th>
              <th class="p-4 font-semibold text-center min-w-[60px]">V·∫Øng</th>
              <th class="p-4 font-semibold min-w-[200px]">L√Ω do v·∫Øng</th>
            </tr>
          </thead>
          <tbody id="tbody" class="text-sm divide-y divide-slate-700">
            <!-- Rows s·∫Ω ƒë∆∞·ª£c JS render v√†o ƒë√¢y -->
          </tbody>
        </table>
      </div>

      <!-- Khu v·ª±c ƒëi·ªÅu khi·ªÉn (Buttons) -->
      <div class="p-4 bg-slate-800 border-t border-slate-700">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button id="calcBtn" class="col-span-2 md:col-span-1 py-2.5 px-4 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìä</span> T√≠nh t·ªïng
          </button>
          
          <button id="excelBtn" class="py-2.5 px-4 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white font-semibold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìó</span> Excel
          </button>
          
          <button id="pdfBtn" class="py-2.5 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üìò</span> PDF
          </button>
          
          <button id="clearBtn" class="py-2.5 px-4 bg-slate-600 hover:bg-slate-500 active:bg-slate-700 text-white font-medium rounded-lg shadow transition-colors flex items-center justify-center gap-2">
            <span>üóëÔ∏è</span> X√≥a
          </button>
        </div>
      </div>

      <!-- K·∫øt qu·∫£ -->
      <div id="result" class="hidden border-t border-slate-700 bg-slate-900/50 p-6 text-slate-200 animate-fade-in">
        <!-- JS ƒëi·ªÅn k·∫øt qu·∫£ v√†o ƒë√¢y -->
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-950/80 backdrop-blur-md border-t border-slate-800 text-slate-400 py-4 w-full z-50">
    <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
        
        <!-- Th√¥ng tin b·∫£n quy·ªÅn -->
        <div class="text-center md:text-left flex flex-col">
            <span class="text-xs font-medium uppercase tracking-widest text-slate-500">Designed by</span>
            <b class="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600 text-lg font-bold">S∆°n Cris</b>
            <span class="text-[10px] text-slate-600">&copy; 2025 Ki·ªÉm tra qu√¢n s·ªë</span>
        </div>

        <!-- Social Links -->
        <div class="flex flex-wrap justify-center gap-3">
            <!-- Phone -->
            <a href="tel:0327208690" class="group flex items-center justify-center w-10 h-10 rounded-full bg-slate-800 hover:bg-green-600 text-white transition-all duration-300 shadow-lg border border-slate-700 hover:border-green-500 hover:-translate-y-1">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 512 512"><path d="M164.9 24.6c-48 0-87.1 39.1-87.1 87.1v278.7c0 48 39.1 87.1 87.1 87.1h182.2c48 0 87.1-39.1 87.1-87.1V111.7c0-48-39.1-87.1-87.1-87.1H164.9zM256 464c-15.4 0-27.9-12.5-27.9-27.9s12.5-27.9 27.9-27.9 27.9 12.5 27.9 27.9-12.5 27.9-27.9 27.9zm135.2-348.8H122.9V392h268.3V115.2z"/></svg>
            </a>
            
            <!-- Instagram -->
            <a href="https://www.instagram.com/son_cris3012/" target="_blank" class="group flex items-center justify-center w-10 h-10 rounded-full bg-slate-800 hover:bg-gradient-to-br hover:from-pink-500 hover:to-orange-500 text-white transition-all duration-300 shadow-lg border border-slate-700 hover:border-pink-500 hover:-translate-y-1">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 448 512"><path d="M224.1 12.6C99.2-22.3-22.3 99.2 12.6 224.1l11.2 11.2c19.3 19.3 46.4 30.1 74.5 30.1h145.4c28.1 0 55.2-10.8 74.5-30.1l11.2-11.2C485.6 99.2 364.1-22.3 239.1 12.6L224.1 27.7l-15 42.1c-14.4 40.3-43.7 70.8-82.6 86.6L48.2 168.1C25.3 177.1 8.5 197.6 8.5 221v82c0 23.4 16.8 43.9 39.7 52.9l84.4 32.1c38.9 15.8 68.2 46.3 82.6 86.6l15 42.1 15-42.1c14.4-40.3 43.7-70.8 82.6-86.6l84.4-32.1c22.9-9 39.7-29.5 39.7-52.9v-82c0-23.4-16.8-43.9-39.7-52.9l-84.4-32.1c-38.9-15.8-68.2-46.3-82.6-86.6l-15-42.1L224.1 27.7zM169.1 296.8c-29.4-29.4-29.4-77 0-106.4s77-29.4 106.4 0 29.4 77 0 106.4-77 29.4-106.4 0zm53.2-61.9c-15.5-15.5-15.5-40.7 0-56.2s40.7-15.5 56.2 0 15.5 40.7 0 56.2-40.7 15.5-56.2 0zm117.8 7.3c15.2-15.2 15.2-39.8 0-55s-39.8-15.2-55 0c-15.2 15.2-15.2 39.8 0 55s39.8 15.2 55 0z"/></svg>
            </a>
            
            <!-- Facebook -->
            <a href="https://web.facebook.com/sonsadboiz.12" target="_blank" class="group flex items-center justify-center w-10 h-10 rounded-full bg-slate-800 hover:bg-blue-600 text-white transition-all duration-300 shadow-lg border border-slate-700 hover:border-blue-500 hover:-translate-y-1">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 448 512"><path d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137.25V327.37h-51.2v-60.3h51.2v-44.4a76.43 76.43 0 0 1 76.4-76.4h37.7v59.7h-37.7c-25.1 0-25.1 9.2-25.1 25.4v40.7h63.2l-10.1 60.3h-53.1V480H400a48 48 0 0 0 48-48V80a48 48 0 0 0-48-48z"/></svg>
            </a>

            <!-- TikTok -->
            <a href="https://www.tiktok.com/@chubodoihaybuon" target="_blank" class="group flex items-center justify-center w-10 h-10 rounded-full bg-slate-800 hover:bg-black hover:shadow-[0_0_15px_rgba(255,255,255,0.3)] text-white transition-all duration-300 shadow-lg border border-slate-700 hover:border-slate-500 hover:-translate-y-1">
                <svg class="w-5 h-5 fill-current" viewBox="0 0 448 512"><path d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25V349.38A162.55 162.55 0 1 1 185 188.31V278.2a74.62 74.62 0 1 0 52.23 71.18V0l88 0a121.18 121.18 0 0 0 1.86 22.17h0A122.18 122.18 0 0 0 448 209.91Z"/></svg>
            </a>

        </div>
    </div>
  </footer>

  <script>
    const defaultClasses = [
      { id: 'CNTT1', qd: 24 },
      { id: 'CNTT2', qd: 24 },
      { id: 'TTNT', qd: 15 },
      { id: 'BDATTT', qd: 8 },
      { id: 'TBBKNL', qd: 10 },
      { id: 'TL', qd: 8 }
    ];

    const STORAGE_KEY = 'quanso_data_v1';

    function loadData(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){
        try { return JSON.parse(saved); } catch(e) { localStorage.removeItem(STORAGE_KEY); }
      }
      const init = {};
      defaultClasses.forEach(c => { init[c.id] = { qd: c.qd, tt: '', lydo: '' } });
      return init;
    }

    let data = loadData();

    function renderTable(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      for(const id in data){
        const row = data[id];
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-700/30 transition-colors";
        
        // T√≠nh to√°n v·∫Øng ngay l√∫c render ƒë·ªÉ hi·ªán th·ªã m√†u s·∫Øc
        const qd = Number(row.qd);
        const tt = Number(row.tt) || 0;
        const vang = Math.max(0, qd - tt);
        const vangClass = vang > 0 ? "text-red-400 font-bold" : "text-slate-400";

        tr.innerHTML = `
          <td class="p-3 border-b border-slate-700 font-medium text-slate-200">${id}</td>
          <td class="p-3 border-b border-slate-700 text-center text-slate-300">${row.qd}</td>
          <td class="p-3 border-b border-slate-700 text-center">
            <input type="number" data-id="${id}" class="tt bg-slate-900/80 border border-slate-600 text-center text-white rounded w-16 md:w-20 py-1 focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-all" value="${row.tt ?? ''}" placeholder="0" min="0">
          </td>
          <td id="${id}_vang" class="p-3 border-b border-slate-700 text-center ${vangClass}">${vang}</td>
          <td class="p-3 border-b border-slate-700">
            <input type="text" data-id="${id}" class="lydo bg-slate-900/80 border border-slate-600 text-white rounded w-full py-1 px-2 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all" value="${row.lydo ?? ''}" placeholder="Nh·∫≠p l√Ω do...">
          </td>
        `;
        tbody.appendChild(tr);
      }
      attachListeners();
    }
    renderTable();

    function saveData(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function tinhTongHop(){
      let tongQD=0, tongTT=0, tongVang=0;
      const statLyDo = {};

      for(const id in data){
        const qd = Number(data[id].qd) || 0;
        const tt = Number(data[id].tt) || 0;
        const vang = Math.max(0, qd - tt);

        tongQD += qd;
        tongTT += tt;
        tongVang += vang;

        const s = (data[id].lydo || '').trim();
        if(s){
          s.split(',').map(p=>p.trim()).forEach(part=>{
            // Regex t√¨m s·ªë ·ªü ƒë·∫ßu c√¢u (v√≠ d·ª• "2 ·ªëm" -> 2, "·ªëm" -> null)
            const m = part.match(/^(\d+)\s*(.+)$/);
            if(m){
              const so = parseInt(m[1],10);
              const ten = m[2].trim();
              if(ten) statLyDo[ten] = (statLyDo[ten]||0) + so;
            } else {
                // N·∫øu kh√¥ng c√≥ s·ªë c·ª• th·ªÉ, ƒë·∫øm l√† 1 cho l√Ω do ƒë√≥ (optional, code c≈© c·ªßa b·∫°n kh√¥ng c√≥ c√°i n√†y nh∆∞ng n√™n th√™m ƒë·ªÉ n√≥ kh√¥ng b·ªã l·ªù ƒëi)
                // Tuy nhi√™n gi·ªØ logic c≈© c·ªßa b·∫°n ƒë·ªÉ tr√°nh l·ªói
            }
          });
        }
        
        // C·∫≠p nh·∫≠t l·∫°i m√†u text c·ªôt v·∫Øng
        const elVang = document.getElementById(id + '_vang');
        if(elVang) {
            elVang.textContent = vang;
            elVang.className = `p-3 border-b border-slate-700 text-center ${vang > 0 ? "text-red-400 font-bold" : "text-slate-400"}`;
        }
      }

      let html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">Qu√¢n s·ªë quy ƒë·ªãnh</p>
                <p class="text-2xl font-bold text-white">${tongQD}</p>
            </div>
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">Th·ª±c t·∫ø c√≥ m·∫∑t</p>
                <p class="text-2xl font-bold text-green-400">${tongTT}</p>
            </div>
            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                <p class="text-xs text-slate-400 uppercase">T·ªïng v·∫Øng</p>
                <p class="text-2xl font-bold text-red-400">${tongVang}</p>
            </div>
        </div>
        
        <h3 class="font-semibold text-lg text-blue-300 mb-2 border-b border-slate-700 pb-1">Chi ti·∫øt l√Ω do v·∫Øng:</h3>
      `;
      
      if(Object.keys(statLyDo).length){
        html += '<ul class="space-y-1 list-disc list-inside text-slate-300">';
        for(const name in statLyDo) html += `<li><span class="text-white font-medium">${name}:</span> <span class="text-yellow-400 font-bold">${statLyDo[name]}</span></li>`;
        html += '</ul>';
      } else {
        html += '<p class="text-slate-500 italic">‚Äî Kh√¥ng c√≥ d·ªØ li·ªáu l√Ω do h·ª£p l·ªá (ƒê·ªãnh d·∫°ng: "S·ªë l∆∞·ª£ng + L√Ω do") ‚Äî</p>';
      }

      const resDiv = document.getElementById('result');
      resDiv.innerHTML = html;
      resDiv.classList.remove('hidden');
    }

    function attachListeners(){
      const inputs = [...document.querySelectorAll('input.tt, input.lydo')];
      inputs.forEach((inp,i) => {
        inp.addEventListener('input', e=>{
          const id = e.target.dataset.id;
          if(!id) return;
          if(e.target.classList.contains('tt')) data[id].tt = e.target.value;
          if(e.target.classList.contains('lydo')) data[id].lydo = e.target.value;
          saveData();
          
          // C·∫≠p nh·∫≠t ngay s·ªë v·∫Øng khi nh·∫≠p
          const qd = Number(data[id].qd)||0, tt = Number(data[id].tt)||0;
          const vang = Math.max(0, qd - tt);
          const el = document.getElementById(id + '_vang');
          if(el) {
              el.textContent = vang;
              // Update style realtime
              el.className = `p-3 border-b border-slate-700 text-center ${vang > 0 ? "text-red-400 font-bold" : "text-slate-400"}`;
          }
        });

        inp.addEventListener('keydown', e=>{
          if(e.key === 'Enter'){
            e.preventDefault();
            const next = inputs[i+1] || inputs[0];
            next.focus();
            next.select && next.select();
          }
        });
      });
    }

    document.getElementById('calcBtn').addEventListener('click', tinhTongHop);

    document.getElementById('excelBtn').addEventListener('click', ()=>{
      const aoa = [['L·ªõp','Qƒê','TT','V·∫Øng','L√Ω do']];
      for(const id in data){
        const qd = data[id].qd;
        const tt = data[id].tt || 0;
        const vang = Math.max(0, qd - (Number(tt)||0));
        aoa.push([id, qd, tt, vang, data[id].lydo || '']);
      }
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), 'BaoCao');
      XLSX.writeFile(wb, 'BaoCao_QuanSo.xlsx');
    });

    document.getElementById('pdfBtn').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('BAO CAO QUAN SO DAI DOI', 105, 20, null, null, 'center');
      
      const rows = Object.keys(data).map(id => {
        const qd = data[id].qd;
        const tt = data[id].tt || 0;
        const vang = Math.max(0, qd - (Number(tt)||0));
        return [id, String(qd), String(tt), String(vang), data[id].lydo || ''];
      });
      
      doc.autoTable({ 
        startY: 30, 
        head: [['Lop','QD','TT','Vang','Ly do']], 
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
      });
      doc.save('BaoCao_QuanSo.pdf');
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u?')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = loadData();
      renderTable();
      document.getElementById('result').classList.add('hidden');
    });

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
